<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Day2Day - Daily Goals & Vibes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Inter', sans-serif; }
  /* Animated gradient header */
  header {
    background: linear-gradient(270deg, #f9a8d4, #f472b6, #ec4899);
    background-size: 600% 600%;
    animation: gradientBG 12s ease infinite;
    color: white; border-radius: 1.5rem; box-shadow: 0 8px 20px rgba(236,72,153,0.25);
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .card-hover:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 30px rgba(219,39,119,0.06); }
  .goals-list::-webkit-scrollbar, .messages-container::-webkit-scrollbar { width: 8px; }
  .goals-list::-webkit-scrollbar-track, .messages-container::-webkit-scrollbar-track { background: #fdf2f8; border-radius: 12px; }
  .goals-list::-webkit-scrollbar-thumb, .messages-container::-webkit-scrollbar-thumb { background: #f472b6; border-radius: 12px; }
  .goal-item:hover .delete-goal-btn { opacity: 1; }
  .calendar-day.has-tasks { background-color: #fce7f3; font-weight: 600; border-radius: 8px; }
  .calendar-day.is-today { box-shadow: 0 0 0 2px #ec4899; }
  .timer-running { animation: pulse 2.5s infinite; color: #f43f5e; }
  .timer-display { font-family: 'Courier New', monospace; font-weight: 700; font-size: 1rem; }
  @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.6;} }
  .play-btn, .stop-btn, .complete-btn { width: 34px; height: 34px; border-radius: 50%; cursor: pointer; transition: all 0.25s; display:flex; align-items:center; justify-content:center; }
  .play-btn { background-color: #f472b6; color: white; }
  .play-btn svg { margin-left: 2px; } /* Nudge the play icon to center */
  .stop-btn { background-color: #fb7185; color: white; }
  .complete-btn { background-color: #ec4899; color: white; }
  .delete-goal-btn { opacity: 0; transition: opacity 0.3s; }
  .message { background-color: #f3f4f6; padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; }
  .message.sent { background-color: #fce7f3; align-self: flex-end; }
  .avatar { width:48px; height:48px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:white; }
  .avatar.small { width:36px; height:36px; }
  .link-bubble { color:#be185d; text-decoration:underline; }
  .fade-in { animation: fadeIn 0.45s ease both; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
</style>
</head>
<body class="bg-pink-50 text-rose-800">

<div class="container mx-auto max-w-5xl px-6 py-8">

  <header class="text-center mb-8 p-6 md:py-8">
    <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-2">Day2Day âœ¨</h1>
    <p class="text-pink-100 font-medium text-base md:text-lg mb-2">Your daily goals, shared vibes & cute timers.</p>
    <div class="text-sm text-pink-200">Create your cute avatar or upload a pic! Incomplete goals can âœ¨magicallyâœ¨ carry forward to the next day for the whole squad.</div>
  </header>

  <div id="members-container" class="grid grid-cols-1 gap-8 mb-8"></div>

  <div id="loader" class="text-center py-10 text-rose-500">Summoning the squad...</div>

  <div id="master-calendar-container" class="bg-white p-6 rounded-3xl shadow-xl mb-6 card-hover"></div>

  <div id="messenger-section" class="bg-white p-6 rounded-3xl shadow-xl mb-10 card-hover">
    <h2 class="text-2xl font-semibold mb-4 text-fuchsia-700 flex items-center gap-3">Group Chat ðŸ’–
      <span class="text-xs bg-pink-50 text-pink-600 px-2 py-1 rounded-full">Links preferred</span>
    </h2>
    <div class="flex items-center gap-3 mb-4">
        <label for="messenger-user-select" class="font-semibold text-pink-600">I am:</label>
        <select id="messenger-user-select" class="p-2 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-400">
            <option value="">-- Select your name --</option>
        </select>
        <button id="toggle-link-mode" class="ml-auto text-sm px-3 py-2 rounded-lg bg-pink-50 text-pink-600">Only links: ON</button>
    </div>
    <div id="messages-container" class="messages-container h-64 overflow-y-auto p-4 bg-rose-50 rounded-xl mb-4 flex flex-col gap-3"></div>
    <div class="flex flex-col sm:flex-row gap-3">
        <input type="text" id="message-input" placeholder="Share a cute link... (e.g. https://...)" class="flex-grow p-3 border border-pink-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
        <button id="send-message-btn" class="bg-pink-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-600 transition-all duration-300 shadow-md">Send Link</button>
    </div>
  </div>

  <div class="bg-white p-6 rounded-3xl shadow-xl card-hover">
    <h2 class="text-2xl font-semibold mb-5 text-fuchsia-700">Add a New Member ðŸŒ¸</h2>
    <div class="flex flex-col sm:flex-row gap-4 items-center">
      <input type="text" id="new-member-name" placeholder="What's your name, superstar?" class="flex-grow p-3 border border-pink-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
      <input type="file" id="new-member-avatar-file" accept="image/*" class="p-2" />
      <button id="gen-avatar-btn" class="bg-pink-100 text-pink-700 px-3 py-2 rounded-xl">Generate Avatar</button>
      <button id="add-member-btn" class="bg-pink-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-600 transition-all duration-300 shadow-md">Join the Group!</button>
    </div>
  </div>

  <div class="mt-6 text-sm text-pink-600 font-medium">Tip: Click a calendar day to view tasks. Use the "Carry Forward" button inside any member card to move incomplete goals from that selected day to the next day for all members.</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, runTransaction, writeBatch, query, orderBy, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCERpjMWaks-VwF0rQl4fTUJA6alU8QnzU",
    authDomain: "day2day-43309.firebaseapp.com",
    projectId: "day2day-43309",
    storageBucket: "day2day-43309.firebasestorage.app",
    messagingSenderId: "796454338022",
    appId: "1:796454338022:web:44db8be83228bb12606a27",
    measurementId: "G-FVWXBE61MD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allMembersData = [];
const memberViewStates = {};
let calendarDate = new Date();
const timerIntervals = {};
let currentMessengerId = localStorage.getItem('currentMessengerId') || ''; // For messenger identity
let messengerOnlyLinks = true;

function getLocalDateString(date) {
  const offset = date.getTimezoneOffset();
  const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
  return adjustedDate.toISOString().split('T')[0];
}
const TODAY_STRING = getLocalDateString(new Date());

function formatTime(milliseconds) {
  const totalSeconds = Math.floor(milliseconds / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  if (hours > 0) {
    return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }
  return `${minutes}:${seconds.toString().padStart(2,'0')}`;
}

function getTotalTimeSpent(goal) {
  let total = goal.totalTime || 0;
  if (goal.isRunning && goal.startTime) {
    total += Date.now() - goal.startTime;
  }
  return total;
}

function renderApp() {
  const tasksByDate = {};
  allMembersData.forEach(member => {
    Object.keys(member.dailyTasks || {}).forEach(date => {
      if (!tasksByDate[date]) tasksByDate[date] = 0;
      tasksByDate[date] += (member.dailyTasks[date] || []).length;
    });
  });
  renderMasterCalendar(calendarDate.getFullYear(), calendarDate.getMonth(), tasksByDate);
  renderMembers(allMembersData);
  updateMessengerUserSelect();
}

function renderMasterCalendar(year, month, tasksByDate) {
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let calendarHtml = `
    <div class="flex items-center justify-between mb-4 px-2">
      <button id="prev-month-btn" class="p-2 rounded-full hover:bg-pink-100 transition" title="Previous Month">&lt;</button>
      <h2 class="text-xl font-bold text-fuchsia-700">${monthNames[month]} ${year}</h2>
      <button id="next-month-btn" class="p-2 rounded-full hover:bg-pink-100 transition" title="Next Month">&gt;</button>
    </div>
    <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-pink-500 px-2">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="grid grid-cols-7 gap-2 mt-2 px-2">`;
  for (let i = 0; i < firstDay; i++) calendarHtml += '<div></div>';
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = getLocalDateString(new Date(year, month, day));
    const hasTasks = tasksByDate[dateStr] > 0;
    const isToday = dateStr === TODAY_STRING;
    calendarHtml += `
      <div class="calendar-day cursor-pointer p-2 rounded-lg ${hasTasks ? 'has-tasks' : ''} ${isToday ? 'is-today' : ''} hover:bg-pink-200" data-date="${dateStr}" title="Click to view tasks for ${dateStr}">
        ${day}
      </div>
    `;
  }
  calendarHtml += '</div>';
  document.getElementById('master-calendar-container').innerHTML = calendarHtml;
}

function renderMembers(members) {
  const container = document.getElementById('members-container');
  container.innerHTML = '';
  if (members.length === 0) {
    document.getElementById('loader').style.display = 'none';
    container.innerHTML = '<p class="text-center text-pink-400 col-span-1">It\'s a bit lonely... be the first to join the party! ðŸ’–</p>';
    return;
  }
  members.forEach(member => {
    const memberCard = document.createElement('div');
    memberCard.className = 'bg-gradient-to-r from-rose-50 to-pink-50 p-6 rounded-3xl shadow-lg flex flex-col fade-in';
    memberCard.setAttribute('data-id', member.id);
    const selectedDate = memberViewStates[member.id] || TODAY_STRING;
    const goalsForSelectedDate = (member.dailyTasks?.[selectedDate] || []).sort((a,b) => {
