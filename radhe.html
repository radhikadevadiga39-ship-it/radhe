<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Day2Day - Daily Goals & Vibes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  body { font-family: 'Inter', sans-serif; }
  /* Animated gradient header */
  header {
    background: linear-gradient(270deg, #f9a8d4, #f472b6, #ec4899);
    background-size: 600% 600%;
    animation: gradientBG 12s ease infinite;
    color: white; border-radius: 1.5rem; box-shadow: 0 8px 20px rgba(236,72,153,0.25);
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .card-hover:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 30px rgba(219,39,119,0.06); }
  .goals-list::-webkit-scrollbar, .messages-container::-webkit-scrollbar, #notes-list-container::-webkit-scrollbar { width: 8px; }
  .goals-list::-webkit-scrollbar-track, .messages-container::-webkit-scrollbar-track, #notes-list-container::-webkit-scrollbar-track { background: #fdf2f8; border-radius: 12px; }
  .goals-list::-webkit-scrollbar-thumb, .messages-container::-webkit-scrollbar-thumb, #notes-list-container::-webkit-scrollbar-thumb { background: #f472b6; border-radius: 12px; }
  .goal-item:hover .delete-goal-btn, .note-item:hover .delete-note-btn { opacity: 1; }
  .calendar-day.has-tasks { background-color: #fce7f3; font-weight: 600; border-radius: 8px; }
  .calendar-day.is-today { box-shadow: 0 0 0 2px #ec4899; }
  .delete-goal-btn, .delete-note-btn { opacity: 0; transition: opacity 0.3s; }
  .message { background-color: #f3f4f6; padding: 0.75rem 1rem; border-radius: 1rem; max-width: 85%; }
  .message.sent { background-color: #fce7f3; align-self: flex-end; }
  .avatar { width:48px; height:48px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:white; }
  .avatar.small { width:36px; height:36px; }
  .link-bubble { color:#be185d; text-decoration:underline; }
  .mode-btn.active { background-color: #ec4899; color: white; }
  .fade-in { animation: fadeIn 0.45s ease both; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
</style>
</head>
<body class="bg-pink-50 text-rose-800">

<div class="container mx-auto max-w-5xl px-6 py-8">

  <header class="text-center mb-8 p-6 md:py-8">
    <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-2">Day2Day ‚ú®</h1>
    <p class="text-pink-100 font-medium text-base md:text-lg mb-2">Your daily goals, shared vibes & private notes.</p>
  </header>

  <div class="flex justify-center gap-4 mb-8">
    <button id="show-group-btn" class="mode-btn active w-40 text-pink-600 bg-white font-semibold py-3 px-8 rounded-full shadow-md transition-all duration-300">Group</button>
    <button id="show-private-btn" class="mode-btn w-40 text-pink-600 bg-white font-semibold py-3 px-8 rounded-full shadow-md transition-all duration-300">Private Notes</button>
  </div>

  <div id="group-mode-wrapper">
    <div id="members-container" class="grid grid-cols-1 gap-8 mb-8"></div>
    <div id="loader" class="text-center py-10 text-rose-500">Summoning the squad...</div>
    <div id="master-calendar-container" class="bg-white p-6 rounded-3xl shadow-xl mb-6 card-hover"></div>
    <div id="messenger-section" class="bg-white p-6 rounded-3xl shadow-xl mb-10 card-hover">
        <h2 class="text-2xl font-semibold mb-4 text-fuchsia-700 flex items-center gap-3">Group Chat üíñ</h2>
        <div class="flex items-center gap-3 mb-4">
            <label for="messenger-user-select" class="font-semibold text-pink-600">I am:</label>
            <select id="messenger-user-select" class="p-2 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-400">
                <option value="">-- Select your name --</option>
            </select>
        </div>
        <div id="messages-container" class="messages-container h-64 overflow-y-auto p-4 bg-rose-50 rounded-xl mb-4 flex flex-col gap-3"></div>
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-3 border border-pink-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
            <button id="send-message-btn" class="bg-pink-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-600 transition-all duration-300 shadow-md">Send</button>
        </div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl card-hover">
        <h2 class="text-2xl font-semibold mb-5 text-fuchsia-700">Add a New Member üå∏</h2>
        <div class="flex flex-col sm:flex-row gap-4 items-center">
        <input type="text" id="new-member-name" placeholder="What's your name, superstar?" class="flex-grow p-3 border border-pink-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:outline-none transition" />
        <button id="gen-avatar-btn" class="bg-pink-100 text-pink-700 px-3 py-2 rounded-xl">Generate Avatar</button>
        <button id="add-member-btn" class="bg-pink-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-600 transition-all duration-300 shadow-md">Join the Group!</button>
        </div>
    </div>
  </div>

  <div id="private-mode-wrapper" style="display: none;" class="fade-in">
    <div class="bg-white p-6 rounded-3xl shadow-xl card-hover">
      <h2 class="text-2xl font-semibold mb-5 text-fuchsia-700">My Private Notes üìù</h2>
      <textarea id="private-note-input" class="w-full p-3 border border-pink-300 rounded-xl h-40 focus:ring-2 focus:ring-pink-500 focus:outline-none transition" placeholder="Jot down your thoughts... they're safe here!"></textarea>
      <button id="save-note-btn" class="mt-4 w-full bg-pink-500 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-600 transition-all duration-300 shadow-md">Save Note</button>
      <div class="mt-8">
        <h3 class="text-xl font-semibold mb-4 text-fuchsia-600">Saved Notes</h3>
        <div id="notes-list-container" class="flex flex-col gap-4 max-h-96 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </div>

</div>
<footer class="text-center text-xs text-rose-400 py-4 mt-4">
  Made by Radhika Devadiga
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, runTransaction, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCERpjMWaks-VwF0rQl4fTUJA6alU8QnzU",
    authDomain: "day2day-43309.firebaseapp.com",
    projectId: "day2day-43309",
    storageBucket: "day2day-43309.firebasestorage.app",
    messagingSenderId: "796454338022",
    appId: "1:796454338022:web:44db8be83228bb12606a27",
    measurementId: "G-FVWXBE61MD"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allMembersData = [];
const memberViewStates = {};
let calendarDate = new Date();
let currentMessengerId = localStorage.getItem('currentMessengerId') || '';

function getLocalDateString(date) {
  const offset = date.getTimezoneOffset();
  const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
  return adjustedDate.toISOString().split('T')[0];
}
const TODAY_STRING = getLocalDateString(new Date());

// --- GROUP MODE FUNCTIONS ---

function renderApp() {
  const tasksByDate = {};
  allMembersData.forEach(member => {
    Object.keys(member.dailyTasks || {}).forEach(date => {
      if (!tasksByDate[date]) tasksByDate[date] = 0;
      tasksByDate[date] += (member.dailyTasks[date] || []).length;
    });
  });
  renderMasterCalendar(calendarDate.getFullYear(), calendarDate.getMonth(), tasksByDate);
  renderMembers(allMembersData);
  updateMessengerUserSelect();
}

function renderMasterCalendar(year, month, tasksByDate) {
  const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let calendarHtml = `
    <div class="flex items-center justify-between mb-4 px-2">
      <button id="prev-month-btn" class="p-2 rounded-full hover:bg-pink-100 transition" title="Previous Month">&lt;</button>
      <h2 class="text-xl font-bold text-fuchsia-700">${monthNames[month]} ${year}</h2>
      <button id="next-month-btn" class="p-2 rounded-full hover:bg-pink-100 transition" title="Next Month">&gt;</button>
    </div>
    <div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-pink-500 px-2">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="grid grid-cols-7 gap-2 mt-2 px-2">`;
  for (let i = 0; i < firstDay; i++) calendarHtml += '<div></div>';
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = getLocalDateString(new Date(year, month, day));
    const hasTasks = tasksByDate[dateStr] > 0;
    const isToday = dateStr === TODAY_STRING;
    calendarHtml += `<div class="calendar-day cursor-pointer p-2 rounded-lg ${hasTasks ? 'has-tasks' : ''} ${isToday ? 'is-today' : ''} hover:bg-pink-200" data-date="${dateStr}" title="Click to view tasks for ${dateStr}">${day}</div>`;
  }
  calendarHtml += '</div>';
  document.getElementById('master-calendar-container').innerHTML = calendarHtml;
}

function renderMembers(members) {
  const container = document.getElementById('members-container');
  container.innerHTML = '';
  if (members.length === 0) {
    document.getElementById('loader').style.display = 'none';
    container.innerHTML = '<p class="text-center text-pink-400 col-span-1">It\'s a bit lonely... be the first to join the party! üíñ</p>';
    return;
  }
  members.forEach(member => {
    const memberCard = document.createElement('div');
    memberCard.className = 'bg-gradient-to-r from-rose-50 to-pink-50 p-6 rounded-3xl shadow-lg flex flex-col fade-in';
    memberCard.setAttribute('data-id', member.id);
    const selectedDate = memberViewStates[member.id] || TODAY_STRING;
    const goalsForSelectedDate = (member.dailyTasks?.[selectedDate] || []).sort((a,b) => a.completed - b.completed);

    const avatarHtml = member.avatarData ?
      `<img src="${member.avatarData}" alt="avatar" class="avatar small" />` :
      `<div class="avatar small" style="background:${member.avatarColor || '#ec4899'}">${(member.name||'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()}</div>`;

    const goalsHtml = goalsForSelectedDate.length > 0
      ? goalsForSelectedDate.map(goal => `
        <div class="goal-item flex items-center justify-between p-3 rounded-xl hover:bg-pink-100 transition group" data-goal-id="${goal.id}" data-goal-date="${selectedDate}">
          <div class="flex items-center flex-grow">
            <input type="checkbox" class="goal-checkbox h-5 w-5 rounded text-pink-600 focus:ring-pink-500" ${goal.completed ? 'checked' : ''} />
            <div class="ml-3 flex-grow">
              <span class="${goal.completed ? 'line-through text-pink-300' : 'text-rose-900'} font-semibold">${goal.text}</span>
              ${goal.description ? `<p class="text-xs text-rose-500 mt-1">${goal.description}</p>` : ''}
            </div>
          </div>
          <button class="delete-goal-btn text-rose-400 hover:text-red-500 opacity-0 group-hover:opacity-100" title="Delete Goal">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        `).join('')
      : '<p class="text-pink-400 p-4">A fresh start! No goals for this day. üå∏</p>';

      memberCard.innerHTML = `
        <div class="flex justify-between items-start mb-5">
          <div class="flex items-center gap-3"> ${avatarHtml} <h3 class="text-2xl font-extrabold text-pink-800">${member.name}</h3> </div>
          <div class="flex items-center gap-3"> <button class="carry-forward-btn text-sm bg-pink-50 text-pink-700 px-3 py-2 rounded-lg">Carry Forward Incomplete</button> <button class="delete-member-btn text-rose-400 hover:text-red-600 text-2xl font-bold" title="Delete Member">&times;</button> </div>
        </div>
        <div class="key-management flex items-center gap-2 p-3 bg-rose-100 rounded-lg mb-4"> <input type="password" class="member-key-set-input flex-grow p-2 border border-pink-300 rounded-lg" placeholder="Set/update your secret key..."> <button class="set-key-btn bg-pink-400 text-white px-3 py-2 rounded-lg text-sm">Set Key</button> </div>
        <div class="flex items-center gap-3 mb-5"> <label class="font-semibold text-pink-600">Tasks for:</label> <input type="date" class="member-date-picker p-2 border border-pink-300 rounded-lg" value="${selectedDate}" /> </div>
        <div class="tasks-viewer flex items-center gap-2 p-3 border-2 border-dashed border-pink-200 rounded-xl"> <input type="password" class="member-key-view-input flex-grow p-2 border border-pink-300 rounded-lg" placeholder="Enter secret key to view tasks..."> <button class="show-tasks-btn bg-pink-500 text-white px-3 py-2 rounded-lg">Show Tasks</button> </div>
        <div class="tasks-wrapper" style="display: none;">
          <div class="goals-list flex-grow overflow-y-auto max-h-80 pr-3">${goalsHtml}</div>
          <div class="mt-6 pt-5 border-t border-pink-200 flex flex-col gap-3">
            <input type="text" class="new-goal-input w-full p-3 border border-pink-300 rounded-xl" placeholder="What's the plan, girly? ‚ú®" />
            <input type="text" class="new-goal-description w-full p-3 border border-pink-200 rounded-xl" placeholder="Add an optional description... üí¨" />
            <button class="add-goal-btn bg-pink-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-pink-700 shadow-md transition">Add Goal</button>
          </div>
        </div>`;
      container.appendChild(memberCard);
  });
}

function updateMessengerUserSelect() {
    const select = document.getElementById('messenger-user-select');
    const currentValue = select.value;
    select.innerHTML = '<option value="">-- Select your name --</option>';
    allMembersData.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id; option.textContent = member.name; select.appendChild(option);
    });
    if (allMembersData.some(m => m.id === currentValue)) { select.value = currentValue; } 
    else if (currentMessengerId && allMembersData.some(m=>m.id===currentMessengerId)) { select.value = currentMessengerId; } 
    else { currentMessengerId = ''; localStorage.removeItem('currentMessengerId'); }
}

function renderMessages(messages) {
    const container = document.getElementById('messages-container');
    container.innerHTML = '';
    if (messages.length === 0) { container.innerHTML = '<p class="text-center text-rose-400">The chat is quiet... share something cute! ‚ú®</p>'; return; }
    messages.forEach(msg => {
        const msgData = msg.data();
        const isSentByCurrentUser = msgData.senderId === currentMessengerId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message flex flex-col ${isSentByCurrentUser ? 'sent' : 'received'}`;
        const senderName = document.createElement('span');
        senderName.className = "font-bold text-sm text-pink-700"; senderName.textContent = msgData.senderName;
        const messageText = document.createElement('p');
        messageText.className = "text-slate-800";
        const text = msgData.text || '';
        const linkRegex = /(https?:\/\/\S+)/g;
        messageText.innerHTML = text.replace(linkRegex, `<a href="$1" target="_blank" rel="noopener" class="link-bubble">$1</a>`);
        const timestamp = document.createElement('span');
        timestamp.className = "text-xs text-slate-500 mt-1 self-end"; timestamp.textContent = msgData.createdAt ? new Date(msgData.createdAt.toDate()).toLocaleString() : '';
        messageDiv.appendChild(senderName); messageDiv.appendChild(messageText); messageDiv.appendChild(timestamp); container.appendChild(messageDiv);
    });
    container.scrollTop = container.scrollHeight;
}

async function handleMemberEvents(e) {
  const memberCard = e.target.closest('.bg-gradient-to-r');
  if (!memberCard) return;
  const memberId = memberCard.dataset.id;
  const memberDocRef = doc(db, 'members', memberId);

  if (e.target.classList.contains('set-key-btn')) {
    const keyInput = memberCard.querySelector('.member-key-set-input');
    const key = keyInput.value;
    if (key) { localStorage.setItem(`day2day_key_${memberId}`, key); alert('Secret key set successfully!'); keyInput.value = ''; } 
    else { alert('Please enter a key.'); }
    return;
  }
  
  if (e.target.classList.contains('show-tasks-btn')) {
    const keyInput = memberCard.querySelector('.member-key-view-input');
    const enteredKey = keyInput.value;
    const storedKey = localStorage.getItem(`day2day_key_${memberId}`);
    if (enteredKey && enteredKey === storedKey) {
      memberCard.querySelector('.tasks-wrapper').style.display = 'block';
      memberCard.querySelector('.tasks-viewer').style.display = 'none';
    } else { alert('Incorrect key! Please set a key first or try again.'); }
    keyInput.value = ''; return;
  }
  
  if (e.target.classList.contains('member-date-picker')) { memberViewStates[memberId] = e.target.value; renderMembers(allMembersData); return; }
  if (e.target.closest('.delete-member-btn')) { if (confirm('Are you sure you want to delete this member?')) { await deleteDoc(memberDocRef); } return; }

  if (e.target.classList.contains('add-goal-btn')) {
    const input = memberCard.querySelector('.new-goal-input');
    const descriptionInput = memberCard.querySelector('.new-goal-description');
    const text = input.value.trim();
    const description = descriptionInput.value.trim();
    const date = memberCard.querySelector('.member-date-picker').value;
    if (text && date) {
      const newGoal = { id: crypto.randomUUID(), text, description, completed: false };
      await updateDoc(memberDocRef, { [`dailyTasks.${date}`]: arrayUnion(newGoal) });
      input.value = ''; descriptionInput.value = '';
    }
    return;
  }

  if (e.target.closest('.carry-forward-btn')) {
    const selectedDate = memberCard.querySelector('.member-date-picker').value;
    if (!selectedDate) return alert('Select a date first');
    if (!confirm(`Carry forward ALL incomplete goals from ${selectedDate} to next day for everyone?`)) return;
    await moveIncompleteGoalsForAll(selectedDate); return;
  }

  const goalItem = e.target.closest('[data-goal-id]');
  if (!goalItem) return;
  const { goalId, goalDate } = goalItem.dataset;

  try {
    await runTransaction(db, async (transaction) => {
      const memberDoc = await transaction.get(memberDocRef);
      if (!memberDoc.exists()) throw "Doc does not exist!";
      const tasks = memberDoc.data().dailyTasks || {};
      const currentGoals = tasks[goalDate] || [];
      let updatedGoals;
      if (e.target.closest('.delete-goal-btn')) { updatedGoals = currentGoals.filter(g => g.id !== goalId); } 
      else if (e.target.classList.contains('goal-checkbox')) { updatedGoals = currentGoals.map(g => g.id === goalId ? { ...g, completed: e.target.checked } : g); } 
      else { return; }
      tasks[goalDate] = updatedGoals;
      transaction.update(memberDocRef, { dailyTasks: tasks });
    });
  } catch (error) { console.error("Transaction failed: ", error); }
}

async function moveIncompleteGoalsForAll(date) {
  const nextDateObj = new Date(date);
  nextDateObj.setDate(nextDateObj.getDate() + 1);
  const nextDate = getLocalDateString(nextDateObj);
  try {
    const membersSnapshot = await getDocs(collection(db, 'members'));
    const promises = [];
    membersSnapshot.forEach(memberDoc => {
      const memberRef = doc(db, 'members', memberDoc.id);
      promises.push(runTransaction(db, async (t) => {
        const md = await t.get(memberRef);
        if (!md.exists()) return;
        const data = md.data();
        const tasks = data.dailyTasks || {};
        const todaysGoals = tasks[date] || [];
        if (todaysGoals.length === 0) return;
        const incomplete = todaysGoals.filter(g => !g.completed);
        if (incomplete.length === 0) return;
        tasks[nextDate] = (tasks[nextDate] || []).concat(incomplete);
        tasks[date] = todaysGoals.filter(g => g.completed);
        t.update(memberRef, { dailyTasks: tasks });
      }));
    });
    await Promise.all(promises);
    alert('Carry-forward complete! Incomplete goals have been moved. ‚ú®');
  } catch (err) { console.error('Carry forward failed:', err); alert('Carry forward failed ‚Äî check console.'); }
}

function generateAvatarDataUrl(name, color) {
  const initials = (name||'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
  const size = 128; const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = color || '#ec4899'; ctx.fillRect(0,0,size,size);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 56px Inter, sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(initials, size/2, size/2);
  return canvas.toDataURL('image/png');
}

// --- PRIVATE NOTES FUNCTIONS ---
function renderPrivateNotes() {
    const container = document.getElementById('notes-list-container');
    const notes = JSON.parse(localStorage.getItem('day2day_private_notes') || '[]');
    if (notes.length === 0) {
        container.innerHTML = `<p class="text-center text-rose-400">You haven't saved any private notes yet.</p>`;
        return;
    }
    container.innerHTML = notes.sort((a,b) => new Date(b.id) - new Date(a.id)).map(note => `
        <div class="note-item flex items-start justify-between p-4 bg-rose-50 rounded-xl group">
            <div>
                <p class="text-rose-800 whitespace-pre-wrap">${note.text}</p>
                <p class="text-xs text-rose-400 mt-2">${new Date(note.id).toLocaleString()}</p>
            </div>
            <button class="delete-note-btn text-rose-400 hover:text-red-500" data-note-id="${note.id}" title="Delete Note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    `).join('');
}

function savePrivateNote() {
    const input = document.getElementById('private-note-input');
    const text = input.value.trim();
    if (!text) return;
    const notes = JSON.parse(localStorage.getItem('day2day_private_notes') || '[]');
    notes.push({ id: new Date().toISOString(), text: text });
    localStorage.setItem('day2day_private_notes', JSON.stringify(notes));
    input.value = '';
    renderPrivateNotes();
}

function deletePrivateNote(noteId) {
    let notes = JSON.parse(localStorage.getItem('day2day_private_notes') || '[]');
    notes = notes.filter(note => note.id !== noteId);
    localStorage.setItem('day2day_private_notes', JSON.stringify(notes));
    renderPrivateNotes();
}

// --- MAIN FUNCTION ---
function main() {
  // Mode switching logic
  const groupBtn = document.getElementById('show-group-btn');
  const privateBtn = document.getElementById('show-private-btn');
  const groupWrapper = document.getElementById('group-mode-wrapper');
  const privateWrapper = document.getElementById('private-mode-wrapper');

  groupBtn.addEventListener('click', () => {
    groupWrapper.style.display = 'block';
    privateWrapper.style.display = 'none';
    groupBtn.classList.add('active');
    privateBtn.classList.remove('active');
  });

  privateBtn.addEventListener('click', () => {
    groupWrapper.style.display = 'none';
    privateWrapper.style.display = 'block';
    privateBtn.classList.add('active');
    groupBtn.classList.remove('active');
    renderPrivateNotes();
  });
  
  // Group Mode Listeners
  onSnapshot(collection(db, 'members'), (snapshot) => {
    document.getElementById('loader').style.display = 'none';
    allMembersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
    renderApp();
  }, (error) => { console.error("Error loading members:", error); document.getElementById('loader').innerHTML = 'Error loading data.'; });

  const messagesQuery = query(collection(db, 'messages'), orderBy('createdAt', 'asc'));
  onSnapshot(messagesQuery, (snapshot) => { renderMessages(snapshot.docs); }, (error) => { console.error("Error loading messages: ", error); });

  document.getElementById('add-member-btn').addEventListener('click', async () => {
    const nameInput = document.getElementById('new-member-name');
    const name = nameInput.value.trim();
    if (!name) return alert('Please enter a name');
    const avatarData = generateAvatarDataUrl(name, pickColorForName(name));
    await addDoc(collection(db, 'members'), { name, dailyTasks: {}, createdAt: serverTimestamp(), avatarData, avatarColor: pickColorForName(name) });
    nameInput.value = '';
  });

  document.getElementById('gen-avatar-btn').addEventListener('click', () => {
    const name = document.getElementById('new-member-name').value.trim() || 'User';
    const data = generateAvatarDataUrl(name, pickColorForName(name));
    const win = window.open();
    win.document.write(`<img src="${data}" alt="avatar" style="width:200px;height:200px;border-radius:20px;display:block;margin:20px;"/>`);
  });

  document.getElementById('master-calendar-container').addEventListener('click', (e) => {
    if (e.target.closest('#prev-month-btn')) { calendarDate.setMonth(calendarDate.getMonth() - 1); renderApp(); }
    if (e.target.closest('#next-month-btn')) { calendarDate.setMonth(calendarDate.getMonth() + 1); renderApp(); }
    const dayCell = e.target.closest('.calendar-day');
    if (dayCell) { const date = dayCell.dataset.date; allMembersData.forEach(member => memberViewStates[member.id] = date); renderMembers(allMembersData); }
  });

  document.getElementById('members-container').addEventListener('click', handleMemberEvents);
  document.getElementById('members-container').addEventListener('change', handleMemberEvents);
  document.getElementById('messenger-user-select').addEventListener('change', (e) => {
      currentMessengerId = e.target.value; localStorage.setItem('currentMessengerId', currentMessengerId);
  });
  document.getElementById('send-message-btn').addEventListener('click', async () => {
      const messageInput = document.getElementById('message-input');
      const text = messageInput.value.trim();
      if (!currentMessengerId) { alert('Hey! Please pick your name from the list to send a message. üòä'); return; }
      if (!text) return;
      const sender = allMembersData.find(m => m.id === currentMessengerId);
      if (!sender) { alert('Could not find your member data.'); return; }
      try { await addDoc(collection(db, 'messages'), { text, senderId: currentMessengerId, senderName: sender.name, createdAt: serverTimestamp() }); messageInput.value = ''; } 
      catch (error) { console.error("Error sending message: ", error); }
  });
  document.getElementById('message-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('send-message-btn').click(); });

  // Private Notes Listeners
  document.getElementById('save-note-btn').addEventListener('click', savePrivateNote);
  document.getElementById('notes-list-container').addEventListener('click', (e) => {
      const deleteBtn = e.target.closest('.delete-note-btn');
      if (deleteBtn) {
          const noteId = deleteBtn.dataset.noteId;
          if (confirm('Are you sure you want to delete this note?')) {
            deletePrivateNote(noteId);
          }
      }
  });
}

function pickColorForName(name) {
  const colors = ['#ec4899', '#f472b6', '#f9a8d4', '#fda4af', '#fb7185', '#e879f9'];
  let h = 0; for (let i=0;i<name.length;i++) h = (h<<5) - h + name.charCodeAt(i);
  return colors[Math.abs(h) % colors.length];
}

main();
</script>

</body>
</html>
